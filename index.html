<!DOCTYPE html>
<html>
<head>
    <title>Audio Poker Monitor</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .meter { 
            width: 100%; 
            height: 20px; 
            background: #eee; 
            margin: 10px 0; 
        }
        .meter-fill { 
            height: 100%; 
            background: #4CAF50; 
            transition: width 0.3s; 
        }
        .decision { 
            padding: 10px; 
            margin: 5px 0; 
            background: #f5f5f5; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Audio Poker Monitor</h1>
        <div>
            <h2>Audio Level</h2>
            <div class="meter">
                <div id="audioMeter" class="meter-fill" style="width: 0%"></div>
            </div>
            <p>RMS: <span id="rmsValue">0</span></p>
            <p>Frequency: <span id="freqValue">0</span> Hz</p>
        </div>
        <div>
            <h2>Recent Decisions</h2>
            <div id="decisions"></div>
        </div>
    </div>

    <script>
        let ws = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        function connectWebSocket() {
            ws = new WebSocket('ws://127.0.0.1:8766');
            
            ws.onopen = function() {
                console.log('WebSocket connected');
                reconnectAttempts = 0;
                // Clear any error messages here if you have them
            };

            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                // Update audio meter
                const meterWidth = Math.min(data.rms * 1000, 100);
                audioMeter.style.width = meterWidth + '%';
                rmsValue.textContent = data.rms.toFixed(6);
                freqValue.textContent = data.freq.toFixed(1);

                // Add decision
                const decision = document.createElement('div');
                decision.className = 'decision';
                decision.textContent = `${data.action.toUpperCase()} - RMS: ${data.rms.toFixed(6)} - Freq: ${data.freq.toFixed(1)} Hz`;
                decisions.insertBefore(decision, decisions.firstChild);

                // Keep only last 10 decisions
                while (decisions.children.length > 10) {
                    decisions.removeChild(decisions.lastChild);
                }
            };

            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                // Display error message to user if needed
            };

            ws.onclose = function() {
                console.log('WebSocket connection closed');
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    console.log(`Attempting to reconnect (${reconnectAttempts}/${maxReconnectAttempts})...`);
                    setTimeout(connectWebSocket, 2000); // Try to reconnect after 2 seconds
                } else {
                    console.log('Max reconnection attempts reached');
                    // Display final error message to user
                }
            };
        }

        // Initial connection
        connectWebSocket();
    </script>
</body>
</html>